---
title: "Exploratory Analysis of School Shootings"
author: "Significantly Different"
date: "March 29, 2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load-packages, message=FALSE}
library(tidyverse)
library(broom)
library(lubridate)

```

```{r load-data, message=FALSE}
school_shootings <- read_csv("../data/school-shootings-data.csv")
```

### Mutation of Variables

We begin by manipulating some of our variables in order to make them more useful. For example, many of our variables are raw and thus, converting them to percentages will be more useful and standardized. 

```{r mutation-races, echo=FALSE}
school_shootings <- school_shootings %>%
  mutate(white_percent = white/enrollment,
         black_percent = black/enrollment,
         hispanic_percent = hispanic/enrollment,
         asian_percent = asian/enrollment)
```

```{r lunch-percent, echo=FALSE}
school_shootings <- school_shootings %>%
  mutate(lunch_percent = lunch/enrollment)
```

```{r}
school_shootings <- school_shootings %>%
  mutate(time = hms::as.hms(time))

#school_shootings <- school_shootings %>%
#  mutate(time_day = case_when(
#    time >= hms::as.hms(6:00:00) & time < hms::as.hms(12:00:00) ~ "morning"
#  ))
```

We create the following variables:

<center>

```white_percent```
```black_percent```
```hispanic_percent```
```asian_percent```
```lunch_percent```

</center>

### Frequency of Annual School Shootings

```{r quan-shootings, fig.width=5, echo=FALSE}
school_shootings %>%
  group_by(year) %>%
  count() %>%
  ggplot(mapping = aes(x = year, y = n)) +
  geom_line() +
  labs(title = "Number of annual school shootings", subtitle = "1999 - 2018") +
  ylab("Frequency") +
  xlab("Year")

```

### Number of Casualties Across the Years

```{r freq-casualties, fig.width=6, echo=FALSE}
school_shootings %>%
  ggplot(mapping = aes(x = year, y = casualties)) +
  geom_point() +
  labs(title = "Casualties over the years 1999 - 2018") +
  ylab("Casualties") +
  xlab("Year")
```

### Distribution of Casualties

```{r dist-casualties, fig.width=5, echo=FALSE}
school_shootings %>%
  ggplot(mapping = aes(x = casualties)) +
  geom_bar() +
  labs(title = "Distribution of Casualties", subtitle = "School Shootings from 1999-2018") +
  xlab("Casualties") +
  ylab("Frequency")
```

### Multivariate Regression Analysis

These are the variables that we will include in our model:

<center>

```enrollment``` 
```factor(shooting_type)```
```staffing```
```white_percent```
```black_percent```
```hispanic_percent```
```asian_percent```
```lunch_percent```
```factor(resource_officer)```
```factor(day_of_week)```

</center>

### Model Creation and Backwards Selection

First, we eliminate variables that will not be useful in our model, such as those used for logistical purposes. 

```{r sel-vars, echo=FALSE}
school_shootings <- school_shootings %>%
  select(school_name, 
         district_name, 
         date, 
         school_year, 
         year, 
         time, 
         day_of_week,
         lunch,
         city, 
         state, 
         school_type, 
         enrollment, 
         killed, 
         injured, 
         casualties, 
         shooting_type, 
         age_shooter1, 
         age_shooter2, 
         gender_shooter1, 
         gender_shooter2, 
         race_ethnicity_shooter1, 
         race_ethnicity_shooter2, 
         shooter_relationship1, 
         shooter_relationship2, 
         resource_officer, 
         weapon, 
         staffing, 
         white_percent, 
         black_percent, 
         hispanic_percent, 
         asian_percent, 
         lunch_percent)
```

### Full Model

We first create a full model, which includes all potential variables. The ```step()``` function automates the backwards selection process for us.

```casualties ~ enrollment + factor(shooting_type) + staffing + white_percent + black_percent + hispanic_percent + asian_percent + lunch_percent + factor(resource_officer) + factor(day_of_week) + (enrollment * staffing) + (lunch_percent * factor(resource_officer))```

### Backwards Selection

```{r back-sel, results='hide', echo=FALSE}
mod_cas <- lm(casualties ~ 
              enrollment +
              factor(shooting_type) +
              staffing + 
              white_percent + 
              black_percent +
              hispanic_percent +
              asian_percent +
              lunch_percent +
              factor(resource_officer) +
              factor(day_of_week) +
              (enrollment * staffing) +
              (lunch_percent * factor(resource_officer)),
              data = school_shootings)

#glance(mod_cas)$adj.r.squared

perf_model <- step(mod_cas, direction = "backward")

perf_model %>%
  tidy() %>%
  select(term, estimate)

glance(perf_model)$adj.r.squared

```

The perfect model is shown below:

```casualties ~ enrollment + staffing + lunch_percent + factor(resource_officer) + enrollment:staffing + lunch_percent:factor(resource_officer) + factor(shooting_type)```

Its adjusted r-squared value is 0.1979681.

